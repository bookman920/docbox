## GIP0005 认证和授权

GIP0005 定义了玩家如何利用自己的钱包，向游戏传递互信的协议和流程，包括：
1、认证：玩家钱包向游戏签发证书，游戏可以离线验证该证书，并获得玩家的可信信息
2、授权：游戏根据证书信息，将链上资产和游戏内资产进行同步，之后玩家就可以在游戏内支配已确权的资产

### token.user

游戏客户端向钱包申领指定用户的登录令牌: 输入游戏编号和玩家编号，输出令牌对象。

#### Example request

```bash
npm run cli rpc token.user $game_id $user_id [$openid]
```

```javascript
//在收到游戏客户端送入的参数后，钱包内部的操作：
connector.execute({method:'token.user', params:[
  'game001',
  'user001',
  'acct001'
]}).then(token => {
  setTimeout(()=>{
    location.href = `/game/${encodeURIComponent(JSON.stringify(token))}`; //跳转至游戏地址，送入令牌信息
  }, 1000);
});

//在收到钱包回传的令牌信息后，游戏服务端的操作：
app.get('/game/:token', async (req, res) => { 
    if(!!req.params.token) {
        try {
            let tokenObj = JSON.parse(decodeURIComponent(req.params.token));
            let ret = verifyData(tokenObj); //verifyData是验签令牌函数，可从核心网引用，或者独立封装
            if(!!ret){
                console.log(`user token verified: `, tokenObj);
            }
            else{
                console.log(`user token verify failed: `, tokenObj);
            }
        }
        catch(e) {
            console.log(`user token verify failed: `, e.message);
        }
    }
});
```

#### Example request body

```json
[
  "{game_id}",
  "{user_id}",
  "{acct_id}"
]
```

Property | Description
---|---
`game_id` |  游戏编号
`user_id` |  游戏内玩家编号
`acct_id` |  游戏内玩家归属账户

#### Example response

```json
{
  "data": {
    "cid": "{game_id}",         //CP编号，也就是游戏编号
    "uid": "{user_id}",         //玩家编号
    "time": "{timestamp}",      //时间戳
    "addr": "{user_address}",   //玩家绑定的收款地址
    "pubkey": "{user_pubkey}"   //玩家收款地址对应的公钥，验签时使用
  },
  "sig": "{token_sig}"          //数据签名，验签时使用
}
```

### balance.all

查询账户余额

#### Example request

```bash
npm run cli rpc balance.all [$acct_id]
```

```javascript
await connector.execute({method:'balance.all', params:['acct001']});
```

入口参数

Property | Description
---|---
`acct_id` |  游戏内玩家归属账户

#### Example response

```json
{
  "unconfirmed": 5000,    //单位尘
  "confirmed": 5000       //单位尘
}
```

#### 衍生指令

- balance.confirmed           只包括确认交易的余额
```json
0.00005   //单位石
```

- balance.unconfirmed         包括未确认交易在内的余额
```json
0.00005   //单位石
```

### queryProps

游戏向核心网发送游戏编码、玩家地址，向对等网络查询该玩家持有的道具列表。

```endpoint
POST http://localhost:17332/public/prop/query/{game_id, user_addr}
```

#### 可访问性

- 开放式连接器 Y - 授权式连接器 Y - 控制台连接器 Y -

#### Example request

```bash
npm run cli rpc queryProps {game_id} {user_addr}
```

```javascript
//基于浏览器的游戏客户端，或没有集成核心库的游戏服务端，向SPV节点/全节点发起API调用
connector.execute({method:'queryProps', params:[
  '{game_id}',
  '{user_addr}'
]}).then(props => {
  for(let prop of props) {
    console.log(prop.pid, prop.oid, prop.gold);
  }
});
```

#### Example request body

```json
[
  "{game_id}",
  "{user_addr}"
]
```

Property | Description
---|---
`game_id`   |  游戏编号
`user_addr` |  游戏内玩家的有效地址

#### Example response

```json
[
  {
    "pid": "{道具编号}",
    "cid": "{游戏编号}",
    "oid": "{道具原始编号}",
    "oper": "exchange",
    "prev": {
      "hash": "{转入交易的哈希}",
      "index": "{关联的输出索引}"
    },
    "current": {
      "hash": "{道具所在交易的哈希}",
      "index": "{关联的输出索引}"
    },
    "gold": "{含金量}",
    "confirm": "{确认数}",
    "root": {
      "hash": "{道具首发交易的哈希}",
      "index": "{关联的输出索引}"
    }
  }
]
```
