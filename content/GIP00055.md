## GIP00055 游戏金链微信小程序钱包与CP接口协议

GIP00055 定义了游戏金链官方微信小程序钱包与CP的接口协议，包括：
1、玩家从小程序钱包进入CP的H5游戏（或小程序游戏），以下简称CP
2、认证：CP向小程序钱包申请证书，并验证证书，获取玩家的可信信息，包括玩家在游戏金链的地址
3、授权：CP根据证书信息，将链上资产和游戏内资产进行同步，使得玩家可以在游戏内支配已确权的资产

### CP信息查询
URL：为cp.create时登记的url
访问路径：URL/info
例如cp.create时登记的url为：https://game.myplay.com,
则CP信息查询的完整地址是：https://game.myplay.com/info，CP需在该地址实现游戏信息的查询，
返回：
```json
{
  "game": {
    "tile": "{game_tile}"    //游戏名称
    "icon_uri": "{game_icon_uri}"      //游戏图标URL
    "large_img_uri": "{game_large_img_uri}"      //游戏大图URL
    "desc": "{game_desc}"    //游戏描述
    "provider" "{game_provider}"    //游戏供应商
    "version" "{game_version}"    //游戏版本
  },
  "apps": {
    "wechat-mini": {   //微信小程序
        "appid": "{appid}"  //微信小程序appid
        "path":  "{path}"   //打开的页面路径
        "version" "{version}"  //小程序版本，有效值 develop（开发版），trial（体验版），release（正式版），默认release
    },
    "h5": {
        "url": "{url}"  //h5游戏入口地址
    },
    "android": {  //安卓app
        "appid": "{appid}"  //微信小程序appid
    }
    "ios": {      //iphone应用
        ...
    }
    ...  //其他
  },
}
```
### CP游戏入口
1、H5游戏入口
h5地址：从cp信息查询返回结果所得
小程序进入H5游戏完整路径：h5地址?source=gamegold-wechat&openid=openid

例如h5地址为：https://game.myplay.com/h5，玩家openid为：oHvae4rF-nfnTQVxuCw6PS9Y8vw0
则玩家从小程序进入CP的完整地址是：https://game.myplay.com/h5/?source=gamegold-wechat&openid=oHvae4rF-nfnTQVxuCw6PS9Y8vw0
其中参数source值为gamegold-wechat，代表是从游戏金链官方微信小程序钱包，如该游戏还接入其他小程序钱包，该值可自行商定

CP需根据openid进行判别，进行新用户的注册或老用户的登录操作

2、小程序游戏入口
appid：微信小程序appid
path：打开的页面路径
小程序钱包调用入口：
```javascript
wx.navigateToMiniProgram({
  appId: '',  CP游戏微信小程序的appid
  path: 打开的页面路径，如：'pages/index/index',
  extraData: {  //传递给CP游戏微信小程序数据
    wallet-openid: 'boHvae4rF-nfnTQVxuCw6PS9Y8vw0ar' //该wallet-openid为钱包小程序的用户openid，非CP小程序的openid
  },
})
```

#### 申请认证
URL: https://mini.gamegold.xin/wallet/user/token
游戏想钱包POST参数：
```json
{
    "game_id": "{game_id}",         //CP编号，也就是游戏在链上注册时候生成的cid
    "user_id": "{user_id}",         //玩家编号
    "acct_id" "{acct_id}"           //acct_id一般取值于用户进入游戏时获取的openid
}
npm run cli rpc token.user $game_id $user_id [$openid]
```
钱包返回令牌信息：
```json
{
  "data": {
    "cid": "{game_id}",         //CP编号，游戏在链上注册时候生成的cid
    "uid": "{user_id}",         //玩家编号
    "time": "{timestamp}",      //时间戳
    "addr": "{user_address}",   //玩家绑定的收款地址
    "pubkey": "{user_pubkey}"   //玩家收款地址对应的公钥，验签时使用
  },
  "sig": "{token_sig}"          //数据签名，验签时使用
}
```
//在收到钱包回传的令牌信息后，游戏服务端的操作：
```javascript
app.get('/game/:token', async (req, res) => { 
    if(!!req.params.token) {
        try {
            let tokenObj = JSON.parse(decodeURIComponent(req.params.token));
            //verifyData是验签令牌函数，参见 gamegoldnode/lib/verifyData.js
            let ret = verifyData(tokenObj); 
            if(!!ret){
                console.log(`user token verified: `, tokenObj);
            }
            else{
                console.log(`user token verify failed: `, tokenObj);
            }
        }
        catch(e) {
            console.log(`user token verify failed: `, e.message);
        }
    }
});
```

